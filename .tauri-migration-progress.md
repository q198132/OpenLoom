# Tauri 2.0 迁移进度记录

## 已完成

### Phase 1: Tauri 项目脚手架（部分完成）

- [x] 安装 `@tauri-apps/cli@^2` 到根 devDependencies
- [x] 创建 `src-tauri/` 目录结构（src/commands/, icons/）
- [x] 创建 `src-tauri/Cargo.toml`（依赖：tauri 2, tauri-plugin-shell 2, serde, notify 7, notify-debouncer-mini, walkdir 2, reqwest 0.12, tokio）
- [x] 创建 `src-tauri/tauri.conf.json`（frontendDist, devUrl, beforeDevCommand, beforeBuildCommand）
- [x] 创建 `src-tauri/build.rs`

### Phase 1 剩余：
- [ ] 创建 `src-tauri/src/main.rs`
- [ ] 创建 `src-tauri/src/lib.rs`（注册所有 commands + plugins）
- [ ] 创建 `src-tauri/src/state.rs`（AppState: workspace_root, recent_projects, snapshot_cache）
- [ ] 前端安装 `@tauri-apps/api@^2`
- [ ] 根 package.json 添加 tauri 脚本
- [ ] 生成默认图标（可用 `npx tauri icon` 或手动放置）

---

## 待实施

### Phase 2: Rust 后端 - 文件系统命令
- [ ] `src-tauri/src/commands/mod.rs`
- [ ] `src-tauri/src/commands/files.rs`（9 个命令：get_file_tree, read_file, write_file, create_file, create_dir, rename_node, delete_node, search_files, list_files）
- 参考：`packages/backend/src/api/fileRoutes.ts`（243行）
- 关键：safe_path 路径安全校验、IGNORED_DIRS/IGNORED_FILES 过滤、BINARY_EXTS 跳过、目录优先排序

### Phase 3: Rust 后端 - Git 命令
- [ ] `src-tauri/src/commands/git.rs`（12 个命令）
- 参考：`packages/backend/src/api/gitRoutes.ts`（252行）
- 所有 Git 操作通过 `std::process::Command` 调用 git CLI
- 关键：porcelain=v1 解析、diff 截断 30KB、log format 字段

### Phase 4: Rust 后端 - 工作区 + AI
- [ ] `src-tauri/src/commands/workspace.rs`（4 个命令：get_workspace, open_workspace, browse_dirs, get_recent）
- [ ] `src-tauri/src/commands/ai.rs`（3 个命令：get_ai_settings, save_ai_settings, generate_commit_message）
- 参考：`packages/backend/src/api/workspaceRoutes.ts` + `aiRoutes.ts`

### Phase 5: Rust 后端 - 文件监听
- [ ] `src-tauri/src/watcher.rs`
- 使用 notify + notify-debouncer-mini（300ms 防抖）
- emit Tauri 事件：file-changed, file-snapshot
- 维护 snapshot_cache
- 参考：`packages/backend/src/watcher/fileWatcher.ts`

### Phase 6: PTY 终端
- 注意：原计划使用 tauri-plugin-pty，但该插件兼容性需验证
- 备选方案：使用 tauri-plugin-shell 或自行封装 PTY

### Phase 7: 前端适配
- [ ] 新建 `packages/frontend/src/lib/api.ts`（统一封装 invoke 调用）
- [ ] 修改 stores：fileTreeStore, editorStore, gitStore, searchStore, workspaceStore, aiSettingsStore, diffReviewStore
- [ ] 重写 `useWebSocket.ts` → Tauri event listeners
- [ ] 重写 `TerminalPanel.tsx` → 使用 PTY 插件
- [ ] 修改 `vite.config.ts`（移除 proxy）
- [ ] 修改 `App.tsx`（WebSocket → Tauri events）

### Phase 8: shared 包修改
- [ ] `packages/shared/src/constants.ts`（移除 WS_PTY_PATH, WS_CONTROL_PATH, API_PREFIX, DEFAULT_PORT）
- [ ] `packages/shared/src/types.ts`（移除 pty-resize 类型）

### Phase 9: 构建与测试
- [ ] `npm run tauri:dev` 验证
- [ ] `npm run tauri:build` 生产构建

---

## 已读取并理解的源文件清单

### 后端（参考，不参与 Tauri 构建）
- `packages/backend/src/index.ts` - 应用入口，Express + WS + PTY + Watcher 初始化
- `packages/backend/src/api/fileRoutes.ts` - 文件操作 API（9 个路由）
- `packages/backend/src/api/gitRoutes.ts` - Git 操作 API（12 个路由）
- `packages/backend/src/api/workspaceRoutes.ts` - 工作区 API（4 个路由）
- `packages/backend/src/api/aiRoutes.ts` - AI API（3 个路由）
- `packages/backend/src/watcher/fileWatcher.ts` - 文件监听器
- `packages/backend/src/workspace/workspaceManager.ts` - 工作区管理器
- `packages/backend/src/pty/ptyManager.ts` - PTY 管理器
- `packages/backend/src/ws/wsHandler.ts` - WebSocket 处理器

### 前端（需要修改）
- `packages/frontend/src/stores/fileTreeStore.ts` - fetch → invoke
- `packages/frontend/src/stores/editorStore.ts` - fetch → invoke
- `packages/frontend/src/stores/gitStore.ts` - fetch → invoke
- `packages/frontend/src/stores/searchStore.ts` - fetch → invoke
- `packages/frontend/src/stores/workspaceStore.ts` - fetch → invoke
- `packages/frontend/src/stores/aiSettingsStore.ts` - fetch → invoke
- `packages/frontend/src/stores/diffReviewStore.ts` - fetch → invoke（rejectReview/rejectAll 中的 write）
- `packages/frontend/src/hooks/useWebSocket.ts` - WebSocket → Tauri events
- `packages/frontend/src/components/terminal/TerminalPanel.tsx` - WS PTY → tauri-plugin-pty
- `packages/frontend/src/App.tsx` - useControlSocket → Tauri event listen
- `packages/frontend/vite.config.ts` - 移除 proxy

### 共享
- `packages/shared/src/constants.ts` - 移除 WS/API 常量，保留 IGNORED_DIRS/IGNORED_FILES
- `packages/shared/src/types.ts` - 微调 ControlMessage
